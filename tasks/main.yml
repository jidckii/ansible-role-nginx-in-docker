- name: Prepare directories for shared folders
  file:
    path: "{{item}}"
    state: directory
  with_items:
    - "{{nginx_dir}}/etc/nginx/conf.d"
    - "{{nginx_dir}}/etc/nginx/ssl"
    - "{{nginx_dir}}/var/log/nginx"
    - "{{nginx_dir}}/var/www/html"

- name: Check dhparam key
  stat:
    path: "{{nginx_dir}}/etc/nginx/ssl/dhparam.pem"
  register: dhparam

- name: Diffie-Hellman parameter for DHE ciphersuites
  shell: "openssl dhparam -out {{nginx_dir}}/etc/nginx/ssl/dhparam.pem {{nginx_openssl_dhparam_numbits}}"
  when: dhparam.stat.exists == false

- name: Setup nginx configs
  register: config
  template:
    src: "templates/etc/nginx/{{item}}"
    dest: "{{nginx_dir}}/etc/nginx/{{item}}"
  with_items:
    - conf.d/htpasswd
    - conf.d/restricted
    - nginx.conf
  notify:
    - Restart nginx

- name: Run nginx server
  register: nginx_container_state
  docker_container:
    expose: '{{nginx_container_options.expose}}'
    image: "{{nginx_container_options.image}}"
    log_driver: "{{nginx_container_options.log_driver}}"
    log_options: "{{nginx_container_options.log_options}}"
    name: "{{nginx_container_name}}"
    network_mode: "{{nginx_container_options.network_mode}}"
    ports: "{{nginx_container_options.ports}}"
    pull: yes
    restart: "{{nginx_container_options.restart}}"
    restart_policy: "{{nginx_container_options.restart_policy}}"
    state: started
    user: root
    volumes: "{{nginx_container_options.volumes}} + [
        '{{nginx_dir}}/etc/nginx/conf.d:/etc/nginx/conf.d:ro',
        '{{nginx_dir}}/etc/nginx/nginx.conf:/etc/nginx/nginx.conf:ro',
        '{{nginx_dir}}/etc/nginx/ssl:/etc/nginx/ssl:ro',
        '{{nginx_dir}}/var/log/nginx:/var/log/nginx',
        '{{nginx_dir}}/var/www/html:/var/www/html:ro'
      ]"
  when: ansible_facts.virtualization_type != "docker"

- meta: flush_handlers